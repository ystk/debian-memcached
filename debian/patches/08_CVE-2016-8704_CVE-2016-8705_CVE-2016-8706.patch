From bd578fc34b96abe0f8d99c1409814a09f51ee71c Mon Sep 17 00:00:00 2001
From: dormando <dormando@rydia.net>
Date: Wed, 12 Oct 2016 13:50:47 -0700
Subject: [PATCH] CVE reported by cisco talos

---
 items.c     |  3 +++
 memcached.c | 10 ++++++++--
 2 files changed, 11 insertions(+), 2 deletions(-)

--- a/items.c
+++ b/items.c
@@ -94,6 +94,9 @@ item *do_item_alloc(char *key, const siz
     uint8_t nsuffix;
     item *it = NULL;
     char suffix[40];
+    if (nbytes < 2 || nkey < 0)
+        return 0;
+
     size_t ntotal = item_make_header(nkey + 1, flags, nbytes, suffix, &nsuffix);
     if (settings.use_cas) {
         ntotal += sizeof(uint64_t);
--- a/memcached.c
+++ b/memcached.c
@@ -1808,10 +1808,16 @@ static bool authenticated(conn *c) {
 static void dispatch_bin_command(conn *c) {
     int protocol_error = 0;
 
-    int extlen = c->binary_header.request.extlen;
-    int keylen = c->binary_header.request.keylen;
+    uint8_t extlen = c->binary_header.request.extlen;
+    uint16_t keylen = c->binary_header.request.keylen;
     uint32_t bodylen = c->binary_header.request.bodylen;
 
+    if (keylen > bodylen || keylen + extlen > bodylen) {
+        write_bin_error(c, PROTOCOL_BINARY_RESPONSE_UNKNOWN_COMMAND, NULL, 0);
+        c->write_and_go = conn_closing;
+        return;
+    }
+
     if (settings.sasl && !authenticated(c)) {
         write_bin_error(c, PROTOCOL_BINARY_RESPONSE_AUTH_ERROR, NULL, 0);
         c->write_and_go = conn_closing;
